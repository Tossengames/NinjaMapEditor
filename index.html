<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shadow Chronicles | Pro Engine & Editor</title>
    <style>
        :root { 
            --gold: #ffcc00; --bg: #1a1a1a; --panel: #2a2a2a; 
            --blue: #007bff; --green: #28a745; --red: #dc3545;
        }

        body { 
            margin: 0; padding: 0; background: var(--bg); color: white; 
            font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; 
        }

        /* Screen Management */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg); z-index: 100; }
        .hidden { display: none !important; }

        /* UI Elements */
        h1 { color: var(--gold); letter-spacing: 5px; margin-bottom: 20px; }
        button { 
            padding: 14px; font-weight: bold; cursor: pointer; background: var(--gold); 
            border: none; border-radius: 6px; margin: 5px 0; width: 100%; max-width: 250px;
        }
        .btn-secondary { background: #444; color: white; }
        
        /* Loadout & Items */
        #loadout-panel { background: #111; padding: 15px; width: 85%; max-width: 400px; border-radius: 15px; border: 1px solid #444; margin-bottom: 20px; }
        .slot-container { display: flex; justify-content: center; gap: 10px; }
        .slot { width: 55px; height: 55px; background: #222; border: 2px dashed #555; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; position: relative; }
        .qty-badge { position: absolute; bottom: -5px; right: -5px; background: var(--gold); color: black; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid #111; }
        .item-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 90%; max-width: 400px; }
        .item-card { background: var(--panel); padding: 10px; border-radius: 8px; border: 1px solid #444; font-size: 11px; cursor: pointer; text-align: center; }

        /* Editor Layout */
        #editor-screen { flex-direction: row; padding: 0; align-items: stretch; }
        #editor-sidebar { 
            width: 280px; background: #111; border-right: 2px solid #444; 
            padding: 15px; text-align: left; overflow-y: auto; z-index: 101; 
            transition: transform 0.3s ease; 
        }
        #editor-sidebar.collapsed { transform: translateX(-280px); position: absolute; }
        
        #side-toggle { position: absolute; top: 10px; left: 10px; z-index: 110; background: var(--gold); border: none; width: 40px; height: 40px; border-radius: 5px; cursor: pointer; font-size: 20px; }

        label { display: block; font-size: 11px; color: #888; margin-top: 10px; text-transform: uppercase; }
        input, textarea, select { background: #222; border: 1px solid #444; color: white; padding: 8px; width: 100%; box-sizing: border-box; margin-top: 4px; border-radius: 4px; font-size: 13px; }

        .palette-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 10px; }
        .pal-item { aspect-ratio: 1; border: 2px solid #444; cursor: pointer; border-radius: 4px; }
        .pal-item.active { border-color: var(--gold); box-shadow: 0 0 8px var(--gold); transform: scale(1.05); }

        /* Viewport Controls */
        #editor-viewport { flex-grow: 1; background: #000; position: relative; overflow: hidden; }
        #floating-controls { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; }

        /* Toolbar */
        #toolbar { position: fixed; bottom: 0; width: 100%; height: 80px; background: rgba(0,0,0,0.9); border-top: 1px solid #444; display: flex; align-items: center; justify-content: center; z-index: 10; }

        /* Modal */
        #export-modal { background: rgba(0,0,0,0.98); padding: 20px; z-index: 500; }
        #export-area { width: 90%; max-width: 600px; height: 300px; background: #000; color: #0f0; font-family: monospace; padding: 10px; font-size: 11px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="menu-screen" class="screen">
        <h1>SHADOW CHRONICLES</h1>
        <button onclick="showMissionList()">PLAY MISSIONS</button>
        <button onclick="openEditor()" style="background: var(--green); color: white;">MAP EDITOR</button>
    </div>

    <div id="mission-screen" class="screen hidden">
        <h2>SELECT CONTRACT</h2>
        <div id="level-list" style="width: 300px; background: #111; border-radius: 8px; margin-bottom: 20px;"></div>
        <button class="btn-secondary" onclick="showMenu()">BACK</button>
    </div>

    <div id="item-screen" class="screen hidden">
        <h2 style="color: var(--gold)">PREPARE LOADOUT</h2>
        <div id="loadout-panel">
            <div id="loadout-display" class="slot-container"></div>
        </div>
        <div id="item-grid" class="item-grid"></div>
        <button onclick="startGame()" style="background: var(--green); color: white; margin-top: 20px;">DEPLOY</button>
        <button class="btn-secondary" onclick="showMenu()">CANCEL</button>
    </div>

    <div id="editor-screen" class="screen hidden">
        <button id="side-toggle" onclick="toggleSidebar()">☰</button>
        
        <div id="editor-sidebar">
            <h3 style="color:var(--gold); margin-top: 40px; margin-bottom: 10px;">MISSION ARCHITECT</h3>
            
            <label>Mission Name</label>
            <input type="text" id="ed-name" value="Operation Nightfall">
            
            <label>Story/Rules</label>
            <textarea id="ed-story" rows="2"></textarea>

            <label>Win Condition</label>
            <select id="ed-condition">
                <option value="reach_exit">Reach the Exit</option>
                <option value="kill_all">Assassinate Target</option>
                <option value="retrieve">Steal Objective</option>
            </select>

            <label>Palette Category</label>
            <select id="palette-cat-select" onchange="filterPalette()">
                <option value="all">Show All</option>
                <option value="walkable">Walkable</option>
                <option value="not_walkable">Not Walkable</option>
                <option value="units">Units (Player/Enemy)</option>
                <option value="collection">Objectives</option>
                <option value="others">Others</option>
            </select>

            <div style="background:#222; padding:8px; border-radius:4px; margin-top:15px; border: 1px solid #333;">
                <span id="selected-tile-name" style="font-size:12px; color:var(--gold); font-weight:bold;">Stone Floor</span>
            </div>
            <div id="palette" class="palette-grid"></div>

            <button onclick="exportMap()" style="background: var(--green); color: white; margin-top: 20px;">EXPORT MAP</button>
            <button onclick="showMenu()" class="btn-secondary">EXIT</button>
        </div>

        <div id="editor-viewport">
            <canvas id="editorCanvas"></canvas>
            <div id="floating-controls">
                <button onclick="togglePencil()" id="pencil-btn" style="width:120px; background:var(--blue); color:white;">✏️ PAINTING</button>
                <button onclick="toggleGrid()" style="width:80px; background:#444; color:white;">GRID</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden" style="position:fixed; inset:0;">
        <canvas id="gameCanvas"></canvas>
        <div id="toolbar">
            <button onclick="showMenu()" class="btn-secondary" style="width:120px;">QUIT MISSION</button>
        </div>
    </div>

    <div id="export-modal" class="screen hidden">
        <h2 style="color:var(--gold)">MAP JSON DATA</h2>
        <textarea id="export-area" readonly></textarea>
        <div style="display:flex; gap:10px; width: 90%; max-width: 400px;">
            <button onclick="copyToClipboard()" style="background:var(--blue); color:white;">COPY CODE</button>
            <button onclick="closeExport()" class="btn-secondary">CLOSE</button>
        </div>
    </div>

    <script src="game.js"></script>
    <script src="editor.js"></script>
</body>
</html>
